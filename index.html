<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shared Audio Queue</title>

<style>
  body {
    background:#000;
    color:#FFD800;
    font-weight:bold;
    font-family:Arial, sans-serif;
    margin:0;
    padding:0;
    user-select:none;
    touch-action:manipulation; /* ✅ eliminates 300ms delay */
  }

  #container {
    position:fixed;
    inset:0;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    text-align:center;
    padding:40px;
    touch-action:none; /* ✅ prevent browser interpreting double tap */
  }

  .invert {
    background:#FFD800 !important;
    color:#000 !important;
  }

  #mainHeader { font-size:20px; transition:opacity .35s ease; }
  #textBox { margin-top:30px; font-size:22px; max-width:900px; white-space:pre-wrap; }
  #debug { margin-top:18px; font-family:monospace; font-size:13px; opacity:0.5; }
</style>
</head>

<body>

<div id="container">
  <h1 id="mainHeader">Tap anywhere to begin</h1>
  <div id="textBox">(text will appear here)</div>
  <div id="debug"></div>
</div>

<audio id="audio"></audio>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
 	apiKey: "AIzaSyDHiFqgdHCUSrkQ69jLu9PdQERVuH0V35o",
        authDomain: "boardgame2025-de850.firebaseapp.com",
        databaseURL: "https://boardgame2025-de850-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "boardgame2025-de850",
        storageBucket: "boardgame2025-de850.firebasestorage.app",
        messagingSenderId: "213373977914",
        appId: "1:213373977914:web:3259e35f2f92bf318e3c03",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const LIB_ROOT = "./Libraries/";
const foldersFallback = {
  "Amorgos":["1","2","3","4","5"],
  "Andros":["1","2","3","4","5"],
  "Answers":[]
};

const headerEl = document.getElementById("mainHeader");
const textBox  = document.getElementById("textBox");
const debugEl  = document.getElementById("debug");
const audioEl  = document.getElementById("audio");
const container = document.getElementById("container");

let folders = {};
let currentFolder = null;
let lastPlayedFile = null;
let audioFinished = true;
let isAnswerPlaying = false;
let doubleTapTimer = null;
let tapLock = false;  // ✅ prevents double registration

function dbg(...a){ console.log(...a); debugEl.textContent = a.join(" "); }

function getParamId(){
  return new URLSearchParams(window.location.search).get("id");
}

function folderQueueRef(folder){
  return db.ref(`folderQueues/${folder}`);
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

async function initFolders(){
  const snap = await db.ref("folders").get();
  if (snap.exists()) folders = snap.val();
  else {
    await db.ref("folders").set(foldersFallback);
    folders = foldersFallback;
  }
}

async function getNextFromQueue(folder){
  const ref = folderQueueRef(folder);
  let snap = await ref.get();
  let queue = snap.exists() ? snap.val() : [];

  const allFiles = folders[folder];
  if (!queue || queue.length === 0){
    queue = shuffle([...allFiles]);
  }

  const next = queue.shift();
  await ref.set(queue);
  return next;
}

async function answerExists(base){
  const mp3 = `${LIB_ROOT}Answers/${base}_a.mp3`;
  const txt = `${LIB_ROOT}Answers/${base}_a.txt`;

  const mp3Exists = await fetch(mp3, {method:"HEAD"}).then(r=>r.ok);
  const txtExists = await fetch(txt, {method:"HEAD"}).then(r=>r.ok);

  return mp3Exists && txtExists;
}

async function playAudio(base, isAnswer=false){
  try{
    const folder = isAnswer ? "Answers" : currentFolder;
    const suffix = isAnswer ? "_a" : "";
    const mp3 = `${LIB_ROOT}${folder}/${base}${suffix}.mp3`;
    const txt = `${LIB_ROOT}${folder}/${base}${suffix}.txt`;

    audioEl.src = mp3;
    audioEl.load();
    await audioEl.play();

    lastPlayedFile = base;
    audioFinished = false;
    isAnswerPlaying = isAnswer;

    const res = await fetch(txt);
    textBox.textContent = res.ok ? await res.text() : "";
  } catch(err){
    dbg("Play error", err);
    textBox.textContent = "Playback error";
  }
}

async function playNext(){
  const next = await getNextFromQueue(currentFolder);
  await playAudio(next);
}

function flashInvert(){
  document.body.classList.add("invert");
  setTimeout(()=>document.body.classList.remove("invert"),100);
}

async function onTap(){
  if (tapLock) return;     // ✅ ignore second event of same tap
  tapLock = true;
  setTimeout(()=>tapLock=false,120);

  flashInvert();

  if (doubleTapTimer){
    clearTimeout(doubleTapTimer);
    doubleTapTimer = null;

    if (isAnswerPlaying){
      audioEl.pause();
      isAnswerPlaying = false;
      return;
    }

    if (!lastPlayedFile) return;

    if (await answerExists(lastPlayedFile)){
      await playAudio(lastPlayedFile,true);
    }

    return;
  }

  doubleTapTimer = setTimeout(async ()=>{
    doubleTapTimer = null;

    if (isAnswerPlaying) return;

    if (audioFinished && lastPlayedFile){
      await playAudio(lastPlayedFile);
      return;
    }

    if (audioFinished){
      await playNext();
    }
  },220);
}

audioEl.addEventListener("ended",()=>{
  audioFinished = true;
  isAnswerPlaying = false;
});

auth.signInAnonymously().then(async ()=>{
  const id = getParamId();
  if (!id){
    textBox.textContent="Missing ?id=FolderName";
    return;
  }

  currentFolder=id;
  await initFolders();

  if (!folders[currentFolder] || currentFolder==="Answers"){
    textBox.textContent="Invalid folder";
    return;
  }

  /* ✅ ONLY ONE EVENT TYPE */
  container.addEventListener("pointerup", onTap);

  dbg("ready");
});
</script>

</body>
</html>

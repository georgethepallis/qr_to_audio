<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Shared Audio Queue with Answers (Secure)</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        margin: 0;
        padding: 40px;
        background: #fff;
        color: #111;
        user-select: none;
      }
      #mainHeader {
        font-size: 20px;
        transition: opacity 0.35s ease;
      }
      #textBox {
        margin-top: 30px;
        font-size: 22px;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        white-space: pre-wrap;
      }
      #debug {
        margin-top: 18px;
        font-family: monospace;
        color: #666;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <h1 id="mainHeader">Tap anywhere to begin</h1>
    <div id="textBox">(text will appear here)</div>
    <div id="debug"></div>
    <audio id="audio"></audio>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDHiFqgdHCUSrkQ69jLu9PdQERVuH0V35o",
        authDomain: "boardgame2025-de850.firebaseapp.com",
        databaseURL:
          "https://boardgame2025-de850-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "boardgame2025-de850",
        storageBucket: "boardgame2025-de850.firebasestorage.app",
        messagingSenderId: "213373977914",
        appId: "1:213373977914:web:3259e35f2f92bf318e3c03",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const auth = firebase.auth();

      const LIB_ROOT = "./Libraries/";
      const foldersFallback = {
        Amorgos: ["1", "2", "3", "4", "5"],
        Andros: ["1", "2", "3", "4", "5"],
        Answers: [], // answer files like 1_a.mp3 and 1_a.txt
      };

      const headerEl = document.getElementById("mainHeader");
      const textBox = document.getElementById("textBox");
      const debugEl = document.getElementById("debug");
      const audioEl = document.getElementById("audio");

      let folders = {};
      let currentFolder = null;
      let doubleTapTimer = null;
      let lastPlayedFile = null;
      let audioFinished = true;
      let isAnswerPlaying = false;
      let userId = null;

      /* ----- Helpers ----- */
      function dbg(...args) {
        console.log(...args);
        debugEl.textContent = args.join(" ");
      }
      function getParamId() {
        return new URLSearchParams(window.location.search).get("id");
      }
      function folderQueueRef(folder) {
        return db.ref(`folderQueues/${folder}`);
      }
      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      /* ----- Initialize folders ----- */
      async function initFolders() {
        const snap = await db.ref("folders").get();
        if (snap.exists()) {
          folders = snap.val();
          dbg("Folders loaded", Object.keys(folders));
        } else {
          await db.ref("folders").set(foldersFallback);
          folders = foldersFallback;
          dbg("Folders fallback written");
        }
      }

      /* ----- Shared queue logic ----- */
      async function getNextFromQueue(folder) {
        const queueRef = folderQueueRef(folder);
        let queueSnap = await queueRef.get();
        let queue = queueSnap.exists() ? queueSnap.val() : [];

        const allFiles = folders[folder];
        if (!queue || queue.length === 0) queue = shuffle([...allFiles]);

        const next = queue.shift();
        await queueRef.set(queue);
        return next;
      }

      /* ----- Play audio ----- */
      async function playAudio(base, isAnswer = false) {
        try {
          const folder = isAnswer ? "Answers" : currentFolder;
          audioEl.src = `${LIB_ROOT}${folder}/${base}${
            isAnswer ? "_a" : ""
          }.mp3`;
          audioEl.load();
          await audioEl.play();
          audioFinished = false;
          isAnswerPlaying = isAnswer;
          lastPlayedFile = base;

          const txtFile = `${LIB_ROOT}${folder}/${base}${
            isAnswer ? "_a" : ""
          }.txt`;
          const txtRes = await fetch(txtFile);
          textBox.textContent = txtRes.ok
            ? await txtRes.text()
            : "(text not found)";
        } catch (err) {
          dbg("Play error", err);
          textBox.textContent = "Failed to play: " + (err.message || err);
        }
      }

      /* ----- Play next audio ----- */
      async function playNext() {
        const next = await getNextFromQueue(currentFolder);
        await playAudio(next);
      }

      /* ----- Tap handler ----- */
      async function onUserTap() {
        if (doubleTapTimer) {
          clearTimeout(doubleTapTimer);
          doubleTapTimer = null;

          // Double tap logic
          if (isAnswerPlaying) {
            audioEl.pause();
            isAnswerPlaying = false;
            dbg("Answer stopped");
          } else if (lastPlayedFile) {
            await playAudio(lastPlayedFile, true); // play answer mp3 + show text
          }
          return;
        }

        doubleTapTimer = setTimeout(async () => {
          doubleTapTimer = null;
          if (isAnswerPlaying) {
            dbg("Tap ignored: answer is playing");
            return;
          }
          if (audioFinished && lastPlayedFile) {
            await playAudio(lastPlayedFile); // replay
          } else if (!lastPlayedFile || audioFinished) {
            await playNext();
          }
        }, 300);
      }

      /* ----- Audio events ----- */
      audioEl.addEventListener("ended", () => {
        audioFinished = true;
        isAnswerPlaying = false;
        dbg("Audio ended");
      });
      audioEl.addEventListener("play", () => {
        audioFinished = false;
        dbg("Audio started");
      });

      /* ----- Initialize Firebase Auth and App ----- */
      auth
        .signInAnonymously()
        .then((userCredential) => {
          userId = userCredential.user.uid;
          dbg("Signed in anonymously as", userId);

          (async function initApp() {
            try {
              const id = getParamId();
              if (!id) {
                textBox.textContent = "Missing ?id=FolderName in URL";
                dbg("Missing folder id");
                return;
              }
              currentFolder = id;

              await initFolders();
              if (!folders[currentFolder] || currentFolder === "Answers") {
                textBox.textContent = `Folder "${currentFolder}" not found. Available: ${Object.keys(
                  folders
                )
                  .filter((f) => f !== "Answers")
                  .join(", ")}`;
                return;
              }

              document.body.addEventListener("pointerup", onUserTap);
              dbg("Ready â€” tap to play, double-tap to play/stop answer");
            } catch (err) {
              dbg("Init error", err);
              textBox.textContent = "Initialization error: " + err.message;
            }
          })();
        })
        .catch((err) => {
          dbg("Auth error", err);
          textBox.textContent = "Failed to authenticate: " + err.message;
        });
    </script>
  </body>
</html>

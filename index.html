<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Shared Audio Queue with Answers</title>

    <style>
      body {
        background: #000;
        color: #ffd800;
        font-weight: bold;
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 40px;
        margin: 0;
        user-select: none;
      }
      #mainHeader {
        font-size: 20px;
        transition: opacity 0.35s ease;
      }
      #textBox {
        margin-top: 30px;
        font-size: 22px;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
        white-space: pre-wrap;
      }
      #debug {
        margin-top: 18px;
        font-family: monospace;
        font-size: 13px;
        opacity: 0.5;
      }
    </style>
  </head>

  <body>
    <h1 id="mainHeader">Tap anywhere to begin</h1>
    <div id="textBox">(text will appear here)</div>
    <div id="debug"></div>

    <audio id="audio"></audio>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDHiFqgdHCUSrkQ69jLu9PdQERVuH0V35o",
        authDomain: "boardgame2025-de850.firebaseapp.com",
        databaseURL:
          "https://boardgame2025-de850-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "boardgame2025-de850",
        storageBucket: "boardgame2025-de850.firebasestorage.app",
        messagingSenderId: "213373977914",
        appId: "1:213373977914:web:3259e35f2f92bf318e3c03",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const auth = firebase.auth();

      /* ============================
   Variables and UI Elements
   ============================ */
      const LIB_ROOT = "./Libraries/";
      const foldersFallback = {
        Amorgos: ["1", "2", "3", "4", "5"],
        Andros: ["1", "2", "3", "4", "5"],
        Answers: [],
      };

      const headerEl = document.getElementById("mainHeader");
      const textBox = document.getElementById("textBox");
      const debugEl = document.getElementById("debug");
      const audioEl = document.getElementById("audio");

      let folders = {};
      let currentFolder = null;
      let lastPlayedFile = null;
      let audioFinished = true;
      let isAnswerPlaying = false;
      let doubleTapTimer = null;

      function dbg(...args) {
        console.log(...args);
        debugEl.textContent = args.join(" ");
      }

      function getParamId() {
        return new URLSearchParams(window.location.search).get("id");
      }

      function folderQueueRef(folder) {
        return db.ref(`folderQueues/${folder}`);
      }

      function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      async function initFolders() {
        const snap = await db.ref("folders").get();
        if (snap.exists()) folders = snap.val();
        else {
          await db.ref("folders").set(foldersFallback);
          folders = foldersFallback;
        }
      }

      /* =============================
   Shared Queue
   ============================= */
      async function getNextFromQueue(folder) {
        const ref = folderQueueRef(folder);
        let snap = await ref.get();
        let queue = snap.exists() ? snap.val() : [];

        const allFiles = folders[folder];
        if (!queue || queue.length === 0) {
          queue = shuffle([...allFiles]);
        }

        const next = queue.shift();
        await ref.set(queue);
        return next;
      }

      /* =============================
   Check for Answer Files
   ============================= */
      async function answerExists(base) {
        const mp3 = `${LIB_ROOT}Answers/${base}_a.mp3`;
        const txt = `${LIB_ROOT}Answers/${base}_a.txt`;

        const mp3Exists = await fetch(mp3, { method: "HEAD" }).then(
          (r) => r.ok
        );
        const txtExists = await fetch(txt, { method: "HEAD" }).then(
          (r) => r.ok
        );

        return mp3Exists && txtExists;
      }

      /* =============================
   Play Normal or Answer Audio
   ============================= */
      async function playAudio(base, isAnswer = false) {
        try {
          const folder = isAnswer ? "Answers" : currentFolder;
          const suffix = isAnswer ? "_a" : "";
          const mp3 = `${LIB_ROOT}${folder}/${base}${suffix}.mp3`;
          const txt = `${LIB_ROOT}${folder}/${base}${suffix}.txt`;

          audioEl.src = mp3;
          audioEl.load();
          await audioEl.play();

          lastPlayedFile = base;
          audioFinished = false;
          isAnswerPlaying = isAnswer;

          const res = await fetch(txt);
          textBox.textContent = res.ok ? await res.text() : "";
        } catch (err) {
          dbg("Play error:", err);
          textBox.textContent = "Playback error";
        }
      }

      async function playNext() {
        const next = await getNextFromQueue(currentFolder);
        await playAudio(next);
      }

      /* =============================
   TAP HANDLING
   ============================= */
      async function onUserTap() {
        if (doubleTapTimer) {
          clearTimeout(doubleTapTimer);
          doubleTapTimer = null;

          // DOUBLE TAP
          // 1) If answer is currently playing → stop it
          if (isAnswerPlaying) {
            audioEl.pause();
            isAnswerPlaying = false;
            dbg("Answer stopped.");
            return;
          }

          // 2) If no file has been played yet → ignore double tap
          if (!lastPlayedFile) return;

          // 3) Check if answer files exist
          const exists = await answerExists(lastPlayedFile);

          // 4) If no answer files → double tap does nothing
          if (!exists) {
            dbg("No answer available → double tap ignored");
            return;
          }

          // 5) If answer exists → play it
          await playAudio(lastPlayedFile, true);
          return;
        }

        // SINGLE TAP
        doubleTapTimer = setTimeout(async () => {
          doubleTapTimer = null;

          // If answer is playing, ignore single taps
          if (isAnswerPlaying) return;

          // Replay last track if finished
          if (audioFinished && lastPlayedFile) {
            await playAudio(lastPlayedFile);
            return;
          }

          // Otherwise play next in queue
          if (audioFinished) {
            await playNext();
          }
        }, 300);
      }

      audioEl.addEventListener("ended", () => {
        audioFinished = true;
        isAnswerPlaying = false;
      });

      /* =============================
   START APP
   ============================= */
      auth.signInAnonymously().then(async (user) => {
        dbg("Signed in:", user.user.uid);

        const id = getParamId();
        if (!id) {
          textBox.textContent = "Missing ?id=FolderName";
          return;
        }

        currentFolder = id;

        await initFolders();

        if (!folders[currentFolder] || currentFolder === "Answers") {
          textBox.textContent = "Invalid folder name.";
          return;
        }

        document.body.addEventListener("pointerup", onUserTap);
        dbg("Ready.");
      });
    </script>
  </body>
</html>
